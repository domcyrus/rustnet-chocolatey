name: Publish to Chocolatey

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.15.0)'
        required: true
        type: string

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Chocolatey
        run: |
          choco --version

      - name: Build package
        shell: pwsh
        run: |
          choco pack
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          echo "PACKAGE_FILE=$($nupkg.Name)" >> $env:GITHUB_ENV
          Write-Host "Built package: $($nupkg.Name)"

      - name: Test package locally
        shell: pwsh
        run: |
          # Install locally
          choco install rustnet -source "'.;https://community.chocolatey.org/api/v2/'" -y

          # Verify installation
          if (Get-Command rustnet -ErrorAction SilentlyContinue) {
            Write-Host "✓ Package installed successfully"
            Write-Host "Note: Skipping version check (requires Npcap Runtime not available in CI)"
          } else {
            Write-Error "✗ Package installation failed"
            exit 1
          }

          # Uninstall for cleanup
          choco uninstall rustnet -y

      - name: Push to Chocolatey Community Repository
        if: github.event_name == 'release'
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if ([string]::IsNullOrEmpty($env:CHOCO_API_KEY)) {
            Write-Warning "CHOCO_API_KEY not set. Skipping push to Chocolatey."
            Write-Host "To enable automatic publishing, add CHOCO_API_KEY to repository secrets."
            exit 0
          }

          $packageFile = $env:PACKAGE_FILE
          Write-Host "Publishing $packageFile to Chocolatey Community Repository..."

          choco apikey --key $env:CHOCO_API_KEY --source https://push.chocolatey.org/

          choco push $packageFile --source https://push.chocolatey.org/

          Write-Host "✓ Package published successfully!"
          Write-Host "Note: It may take some time for the package to be approved by moderators."

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-package
          path: "*.nupkg"

      - name: Comment on PR
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ github.event.release.tag_name }}'.replace(/^v/, '');

            // Find the update PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc'
            });

            const updatePR = prs.find(pr =>
              pr.title.includes(version) && pr.merged_at
            );

            if (updatePR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: updatePR.number,
                body: `✓ Package for version ${version} has been published to Chocolatey Community Repository.\n\n` +
                      `It may take some time for moderators to approve it.\n\n` +
                      `**Release:** ${context.payload.release.html_url}`
              });
            }
