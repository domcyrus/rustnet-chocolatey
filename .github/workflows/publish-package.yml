name: Publish to Chocolatey

on:
  workflow_dispatch:
    inputs:
      confirm_publish:
        description: 'Confirm publish to Chocolatey Community Repository'
        required: true
        type: boolean
        default: false

jobs:
  publish:
    if: inputs.confirm_publish
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get package version
        id: version
        shell: pwsh
        run: |
          $version = ([xml](Get-Content rustnet.nuspec)).package.metadata.version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Package version: v$version"

      - name: Build package
        shell: pwsh
        run: |
          choco pack
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          echo "PACKAGE_FILE=$($nupkg.Name)" >> $env:GITHUB_ENV
          Write-Host "Built package: $($nupkg.Name)"

      - name: Test package locally
        shell: pwsh
        run: |
          choco install rustnet -source "'.;https://community.chocolatey.org/api/v2/'" -y

          if (Get-Command rustnet -ErrorAction SilentlyContinue) {
            Write-Host "Package installed successfully"
          } else {
            Write-Error "Package installation failed"
            exit 1
          }

          choco uninstall rustnet -y

      - name: Push to Chocolatey Community Repository
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if ([string]::IsNullOrEmpty($env:CHOCO_API_KEY)) {
            Write-Error "CHOCO_API_KEY not set. Add it to repository secrets."
            exit 1
          }

          $packageFile = $env:PACKAGE_FILE
          Write-Host "Publishing $packageFile to Chocolatey Community Repository..."

          choco apikey --key $env:CHOCO_API_KEY --source https://push.chocolatey.org/
          choco push $packageFile --source https://push.chocolatey.org/

          Write-Host "Package published successfully!"
          Write-Host "Note: Moderator approval may take some time."

      - name: Create summary
        if: always()
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"

          @"
          ### Chocolatey Package Publish

          - **Version:** v$version
          - **Package:** $env:PACKAGE_FILE
          - **Status:** Published to Chocolatey Community Repository

          Note: Moderator approval may take some time before the package is publicly available.
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
