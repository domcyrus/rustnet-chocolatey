name: Update Chocolatey Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'RustNet version to update to (e.g., v0.18.0 or 0.18.0)'
        required: true
        type: string
      publish:
        description: 'Publish to Chocolatey Community Repository'
        required: false
        type: boolean
        default: true

jobs:
  update-package:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current package version
        id: current
        shell: pwsh
        run: |
          $currentVersion = ([xml](Get-Content rustnet.nuspec)).package.metadata.version
          echo "version=$currentVersion" >> $env:GITHUB_OUTPUT
          Write-Host "Current package version: v$currentVersion"

      - name: Normalize version input
        id: version
        shell: pwsh
        run: |
          # Strip 'v' prefix if provided (e.g., v0.18.0 -> 0.18.0)
          $version = "${{ inputs.version }}" -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Target version: v$version"

      - name: Check if update is needed
        id: check
        shell: pwsh
        run: |
          $current = "${{ steps.current.outputs.version }}"
          $target = "${{ steps.version.outputs.version }}"

          if ($current -eq $target) {
            echo "needs_update=false" >> $env:GITHUB_OUTPUT
            Write-Host "Package is already up to date (v$current)"
          } else {
            echo "needs_update=true" >> $env:GITHUB_OUTPUT
            Write-Host "Update needed: v$current -> v$target"
          }

      - name: Download binary and calculate checksum
        if: steps.check.outputs.needs_update == 'true'
        id: checksum
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $url = "https://github.com/domcyrus/rustnet/releases/download/v$version/rustnet-v$version-x86_64-pc-windows-msvc.zip"

          Write-Host "Downloading from: $url"
          Invoke-WebRequest -Uri $url -OutFile "rustnet.zip"

          $checksum = (Get-FileHash -Algorithm SHA256 rustnet.zip).Hash.ToLower()
          echo "checksum=$checksum" >> $env:GITHUB_OUTPUT
          Write-Host "Calculated checksum: $checksum"

          # Clean up
          Remove-Item rustnet.zip

      - name: Update package files
        if: steps.check.outputs.needs_update == 'true'
        shell: pwsh
        env:
          CURRENT_VERSION: ${{ steps.current.outputs.version }}
          NEW_VERSION: ${{ steps.version.outputs.version }}
          CHECKSUM: ${{ steps.checksum.outputs.checksum }}
        run: |
          Write-Host "Updating package with:"
          Write-Host "  Version: v$env:CURRENT_VERSION -> v$env:NEW_VERSION"
          Write-Host "  Checksum: $env:CHECKSUM"

          # Update nuspec version
          $nuspecPath = "rustnet.nuspec"
          $nuspecContent = Get-Content $nuspecPath -Raw
          $nuspecContent = $nuspecContent -replace '<version>[\d\.]+</version>', "<version>$env:NEW_VERSION</version>"
          Set-Content -Path $nuspecPath -Value $nuspecContent -NoNewline

          # Update chocolateyinstall.ps1 URL and checksum
          $installScriptPath = "tools\chocolateyinstall.ps1"
          $installContent = Get-Content $installScriptPath -Raw
          $installContent = $installContent -replace 'releases/download/v[\d\.]+/rustnet-v[\d\.]+-', "releases/download/v$env:NEW_VERSION/rustnet-v$env:NEW_VERSION-"
          $installContent = $installContent -replace "checksum64 = '[^']*'", "checksum64 = '$env:CHECKSUM'"
          Set-Content -Path $installScriptPath -Value $installContent -NoNewline

          Write-Host "Package files updated successfully"
          Write-Host ""
          Write-Host "Changes:"
          git diff

      - name: Build package
        if: steps.check.outputs.needs_update == 'true'
        shell: pwsh
        run: |
          choco pack
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          Write-Host "Built package: $($nupkg.Name)"

      - name: Test package installation
        if: steps.check.outputs.needs_update == 'true'
        shell: pwsh
        run: |
          choco install rustnet -source "'.;https://community.chocolatey.org/api/v2/'" -y

          if (Get-Command rustnet -ErrorAction SilentlyContinue) {
            Write-Host "Package installed successfully"
            Write-Host "Note: Skipping version check (requires Npcap Runtime)"
          } else {
            Write-Error "Package installation failed"
            exit 1
          }

          choco uninstall rustnet -y

      - name: Commit and push changes
        if: steps.check.outputs.needs_update == 'true'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add rustnet.nuspec tools/chocolateyinstall.ps1
          git commit -m "Update RustNet to version v$version"
          git push

      - name: Publish to Chocolatey
        if: steps.check.outputs.needs_update == 'true' && inputs.publish
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if ([string]::IsNullOrEmpty($env:CHOCO_API_KEY)) {
            Write-Warning "CHOCO_API_KEY not set. Skipping publish."
            Write-Host "To enable publishing, add CHOCO_API_KEY to repository secrets."
            exit 0
          }

          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          Write-Host "Publishing $($nupkg.Name) to Chocolatey Community Repository..."

          choco apikey --key $env:CHOCO_API_KEY --source https://push.chocolatey.org/
          choco push $nupkg.Name --source https://push.chocolatey.org/

          Write-Host "Package published successfully!"
          Write-Host "Note: Moderator approval may take some time."

      - name: Create summary
        if: always()
        shell: pwsh
        run: |
          $current = "${{ steps.current.outputs.version }}"
          $target = "${{ steps.version.outputs.version }}"
          $needsUpdate = "${{ steps.check.outputs.needs_update }}"
          $checksum = "${{ steps.checksum.outputs.checksum }}"
          $publish = "${{ inputs.publish }}"

          @"
          ### Chocolatey Package Update

          - **Current Version:** v$current
          - **Target Version:** v$target

          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

          if ($needsUpdate -eq "true") {
            @"
          **Package Updated Successfully!**

          - **New Version:** v$target
          - **SHA256 Checksum:** ``$checksum``
          - **Published to Chocolatey:** $(if ($publish -eq "true") { "Yes" } else { "No" })

          **Validation:**
          - Package built successfully
          - Installation tested on Windows
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          } else {
            @"
          **No Update Needed**

          The package is already at the target version.
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
